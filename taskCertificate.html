<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,minimal-ui">
	<title>任务凭证</title>
	<link rel="stylesheet" href="./css/common.css">
	<link rel="stylesheet" href="./css/page.css">
	<script src='inc/remset.js'></script>
	<style>
		.taskCertificate-wrap {
			padding: 1rem;
			height: 100%;
		}

		/* 任务信息卡片 */

		.taskCertificate-wrap .card-item {
			background-color: #efeff4;
			padding: 0 0.75rem;
			width: 17.05rem;
			height: 4.5rem;
			margin: 0 auto;
			border-radius: 0.3rem;
			margin-bottom: 1.5rem;
		}

		/* 任务内容 */

		.taskCertificate-wrap .card-item .task-content {
			float: left;
		}

		.taskCertificate-wrap .card-item .task-content .title {
			font-size: 0.75rem;
			font-weight: 500;
			margin: 0.625rem 0 0.45rem 0;
		}

		.taskCertificate-wrap .card-item .task-content .publisher {
			font-size: 0.5rem;
			margin-bottom: 0.25rem;
		}

		.taskCertificate-wrap .card-item .task-content .time-limit {
			font-size: 0.5rem;
		}

		/* 任务赏金 */

		.taskCertificate-wrap .card-item .task-bounty {
			font-size: 0.75rem;
			color: #ff4b2b;
			float: right;
			line-height: 4.5rem;
		}

		.taskCertificate-wrap .card-item .task-bounty span {
			font-size: 1.5rem;
		}

		/* 上传凭证 */

		.taskCertificate-wrap .upload-box {
			margin-bottom: 15px;
		}

		.taskCertificate-wrap .upload-box .upload-area {
			width: 100%;
			min-height: 11.425rem;
			border: 1px solid #e6e6e6;
			margin: 0 auto;
			padding-bottom: 0px;
			padding: .5rem;
		}

		.taskCertificate-wrap .upload-box .upload-area textarea {
			width: 100%;
			min-height: 4.525rem;
		}

		.taskCertificate-wrap .upload-box .upload-area .btn-upload,
		.taskCertificate-wrap .upload-box .upload-area .img-item {
			flex: 0 0 4.25rem;
			width: 4.5rem;
			height: 4.5rem;
			display: inline-block;
			margin-right: 0.5rem;
			margin-bottom: 1rem;
			position: relative;
		}

		.taskCertificate-wrap .upload-box .upload-area .btn-upload img,
		.taskCertificate-wrap .upload-box .upload-area .img-item img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.taskCertificate-wrap .upload-box span,
		.tips {
			font-size: 0.6rem;
			color: #999;
			padding-left: 1rem;
		}

		.tips {
			margin-top: 1rem;
			color: #ff4b2b
		}

		/* 审核按钮 */

		.taskCertificate-wrap .btn-review {
			width: 15.75rem;
			height: 2rem;
			line-height: 2rem;
			border-radius: 0.25rem;
			font-size: 0.75rem;
			color: #fff;
			background-color: #ff4b2b;
			text-align: center;
			margin: 0 auto 1rem auto;
		}

		/*UpImage*/

		#UpImageBox {
			position: absolute;
			top: 0px;
			left: 0px;
			width: 100%;
			height: 100%;
			z-index: 1000;
			text-align: center;
			overflow: hidden;
			display: none;
		}

		#UpImageBox .nav {
			background: #393A3F;
			height: 50px;
			overflow: hidden;
		}

		#UpImageBox .nav>span {
			display: inline-block;
			margin: 10px;
			text-align: center;
		}

		#UpImageBox .back {
			float: left;
			background: url(images/back_w.png) no-repeat center center;
			width: 1.2rem;
			height: 1.2rem;
		}

		#UpImageBox .select {
			color: #fff;
			background: transparent;
			border-radius: 5px;
			float: right;
			line-height: 30px;
			width: 2.5rem;
			height: 1.5rem;
		}

		#UpImageBox .content {
			height: 300px;
			width: 300px;
			overflow: hidden;
			margin: 20px auto 0px auto;
			background-size: cover;
			border: 1px solid #fff;
			background-repeat: no-repeat;
			background-position: center center;
		}

		#UpImageBox .mask {
			height: 100%;
			width: 100%;
			float: right;
			background: #AAA;
			opacity: .9;
			font-size: 0px;
			overflow: hidden;
		}

		#UpImageBox .upmess {
			line-height: 50px;
			text-align: center;
			color: #000;
		}

		.img-item {
			position: relative;
		}

		.remove {
			width: 1rem !important;
			height: 1rem !important;
			position: absolute;
			top: -.5rem;
			right: -.5rem;
		}
		.reason-title {
			padding: 1rem .5rem;
			color: #ff4b2b
		}
	</style>
</head>

<body>
	<div class="taskCertificate-wrap wrap-box">
		<div class="card-box">

		</div>
		<!-- 上传凭证 -->
		<div class="reason-title" style="display: none;">

		</div>
		<div class="upload-box">
			<div class="upload-area">
				<textarea placeholder="内容描述..." id="remark"></textarea>
				<div class="img-box">
					<div class="btn-upload" id='addBox'>
						<img src="./images/addImg.png" alt="">
					</div>
				</div>
			</div>
			<span>上传凭证（最多可上传9张）</span>
			<p v-show='isNew' class="tips">预计审核时间为七个工作日</p>
		</div>
		<!-- 审核按钮 -->
		<div class="btn-review" onclick='send()'>提交凭证</div>
	</div>
	<script src="inc/z.js"></script>
	<script src='inc/page.js'></script>
	<script src="inc/g.js"></script>
	<script src="inc/upimg//upload.js"></script>
	<script src="inc/model.js"></script>
	<script src='inc/template.js'></script>
	<script type="text/template" id="card">
        <div class="task-card" >
            <div class="card-item">
                <div class="type-flag">
                    <div class="flag">{{flag}}</div>
                </div>
                <div class="task-content">
                    <div class="title">{{name || task.name}}</div>
                    <div class="publisher">发布商家：
                        <span>{{shopName}}</span>
                    </div>
                    <div class="time-limit">任务时间：
                        <span >{{begin}}</span> 至
                        <span>{{end}}</span>
                    </div>
                </div>
                <div class="task-bounty">¥
                    <span>{{singleAmount}}</span>
                </div>
            </div>
        </div>
	</script>
	<script>
		var taskId = Comm.query('taskId') || null, imgList = [], userStatus, userTaskId, userDetailId,load;
		function pageload() {
			loadData();
		}
		function loadData() {
			AJAX.GET('/api/task/getDetailById?taskId=' + taskId + "&userId=5", function (res) {
				if (res.code == 1) {
					userStatus = res.data.missionTask.userStatus;
					userTaskId = res.data.missionTask.userTaskId
					var obj = forMart([res.data.missionTask])[0]
					var html = template('card', obj);
					document.querySelector('.card-box').innerHTML = html;
					if (userStatus == 2 || userStatus == 5) {
						addStaffImg()
					} else if (userStatus == 3) {
						getProvData()
					} else {
						Prompt.msg('任务已过期，请重新领取')
						setTimeout(() => {
							Nav.back()
						}, 800);
					}
				} else {
					Prompt.msg('网络连接失败,请稍后再试');
					setTimeout(() => {
						Nav.back()
					}, 800);
				}

			})
		}
		function addStaffImg() {
			if(load){load=null};
			load = new imgUploader("addBox");
			load.fill = function () {
				if (imgList.length >= 9) { return Prompt.msg('最多上传9张图片') }
				imgList.push(this.getList()[0]);
				var index = imgList.length - 1;
				var div = document.createElement('DIV');
				var img = document.createElement('IMG');
				var remove = document.createElement('IMG');
				remove.setAttribute('src', 'images/remove.jpg')
				remove.className = 'remove';
				img.setAttribute('src', config.ossroot + this.getList()[0]);
				div.className = 'img-item';
				div.appendChild(img)
				div.appendChild(remove)
				document.querySelector('.img-box').insertBefore(div, document.getElementById('addBox'));
				remove.addEventListener('click',function(){
					Prompt.confirm('确定要删除这张图片吗？',function(a){
						if(a){
							document.querySelector('.img-box').removeChild(div);
							imgList.splice(index,1);
							if(imgList.length <= 8){toggleLoadBtn('inline-block')}
							addStaffImg()
						}
					})
				})
				if (imgList.length == 9) { toggleLoadBtn('none') }
			}
		}
		function getProvData() {
			Prompt.loading()
			AJAX.GET('/api/task/getApplyById?userTaskId=' + userTaskId + '&userDetailId=' + userDetailId, function (res) {
				Prompt.hide();
				document.getElementById('addBox').style.display='none';
				document.querySelector('.btn-review').style.display = 'none';
				document.getElementById('remark').setAttribute('readOnly',true)
				var voucher = res.data.voucher.split(',');
				document.getElementById('remark').value = res.data.remark || '';
				if (voucher.length) {
					document.querySelector('.tips').style.display = 'none';
					document.querySelector('.reason-title').style.display = 'block';
					document.querySelector('.reason-title').innerHTML = '审核中，预计审核时间为七个工作日';
					
					for (var i = 0; i < voucher.length; i++) {
						var div = document.createElement('DIV');
						var img = document.createElement('IMG');
						img.setAttribute('src', config.ossroot + voucher[i]);
						div.className = 'img-item';
						div.appendChild(img)
						document.querySelector('.img-box').insertBefore(div, document.getElementById('addBox'));
					}
					if (i >= 8) {
						toggleLoadBtn('none')
					}
				}
				if (userStatus == 5) {
					document.querySelector('.tips').style.display = 'none';
					document.querySelector('.reason-title').style.display = 'block';
					document.querySelector('.reason-title').innerHTML = '审核失败，失败原因为：' + res.data.reason;
				}
			})
		}
		function send() {
			if (imgList.length) {
				var voucher = imgList.join(',');
				var remark = document.getElementById('remark').value;
				AJAX.POST('/api/taskUser/completeApply', { userTaskId: userTaskId, userDetailId: userDetailId || '', voucher: voucher, remark: remark }, function (res) {
					if (res.code == 1) {
						Prompt.msg('提交审核成功');
						setTimeout("Nav.gotop()", 1200);
					} else {
						Prompt.msg(res.msg);
					}
				})
			} else {
				Prompt.msg('至少上传一张凭证')
			}
		}
		function toggleLoadBtn(display) {
			document.getElementById('addBox').style.display = display
		}
	</script>
</body>

</html>